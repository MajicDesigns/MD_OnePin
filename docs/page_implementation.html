<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>One Pin Comms Link: Library Implementation Overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="MajicDesigns_Logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">One Pin Comms Link<span id="projectnumber">&#160;1.0</span>
   </div>
   <div id="projectbrief">One Pin Serial comms link layer implemented in software only</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('page_implementation.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Library Implementation Overview </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Overview</h2>
<p >The library is implemented as a class <a class="el" href="class_m_d___one_pin.html">MD_OnePin</a> to implement the PRI side of the link. This has primitives to read, write and reset the link interface (basically all the signals), and is implemented just using documented Arduino library calls (ie, no assembler, timer or other hardware specific features). This part is designed to be portable across architectures.</p>
<p >The SEC side is implemented as 'C' code that responds to the PRI signalling. The library's example SEC implementations detect and time the PRI initiating signal in and Interrupt Service Routine (ISR), setting a flag for the main loop() to do most of the processing. The majority of the SEC can be written using portable functions, but it is possible that for some applications a more low level approach may be required to implement the same, or similar, logic. In other words, the SEC node is application dependent.</p>
<p >The example SEC use an ISR tied to an external interrupt connected to the PRI digital I/O. However, the same could work off other suitable interrupt types, such as pin change interrupts.</p>
<p >The main loop() uses the flag set in the ISR then uses this information to implement the remaining protocol response and reconstruct data packets. In this way the majority of the processing is implemented outside the ISR.</p>
<p >As the two ends of the link both read and write to the link, PRI and SEC orchestrate changing the I/O pin between INPUT and OUTPUT. These changes are described in the section below.</p>
<h2>Tailoring implementations</h2>
<p >The packet size from PRI to SEC and SEC to PRI can be different sizes, between 1 and 32 bits. PRI to SEC is expected to be larger as this flow may include configuration parameters, command codes, queries, etc. SEC to PRI is likely to consist of status and other 'lightweight' information. In any event, the bits per packet for both flows are defined in the <a class="el" href="_m_d___one_pin___protocol_8h.html" title="Header for MD_OnePin library link protocol timing parameters.">MD_OnePin_Protocol.h</a> header file, the class constructor for <a class="el" href="class_m_d___one_pin.html">MD_OnePin()</a> and the SEC code implementation.</p>
<p >At microsecond time intervals, higher level libraries introduce noticeable time delays when switching I/O pins between INPUT/OUTPUT and reading/writing writing to digital outputs. The PRI implementation measures an average value for this in begin() and adjusts timing parameters/delays to take these into account.</p>
<p >Another source of potential issues are the timing gap between packet detection in SEC and the processing of the packet in loop(). For short T slots it is possibler that PRI has moved on through the signal becore SEC has started its processing. This is especially likely when there is a considerable computing disparity between PRI and SEC (for example, a 16Mhz clock compared to 8MHz).</p>
<p >All protocol message timing is defined in the <a class="el" href="_m_d___one_pin___protocol_8h.html" title="Header for MD_OnePin library link protocol timing parameters.">MD_OnePin_Protocol.h</a> header file. The base time slot T is defined as OPT and all other timing parameters are derived from this. Changing this single constant value is the correct way to fine-tune timing related communications issues.</p>
<h2>Message Processing</h2>
<p >This section descibes the detailed implementation and coordination between PRI and SEC implementation of the OnePin protocol.</p>
<h3>Reset/Presence Signal</h3>
<ol type="1">
<li>The PRI pulls the signal low for OPT_RST_SIGNAL time.</li>
<li>At end of signal time, PRI switches the I/O pin to a digital input.</li>
<li>The SEC detects the reset signal and switches to digital output.</li>
<li>The SEC signals its presence by switching low and holding for OPT_RST_PRESENCE time.</li>
<li>The PRI samples the signal at OPT_RST_PRS_SAMPLE time for the slave signal.</li>
<li>After sampling presence signal PRI switches I/O to digital output.</li>
<li>At end of signal period SEC switches I/O pin to digital input.</li>
<li>PRI delays OPT_RST_END time before sending the next part of communications.</li>
</ol>
<h3>Write Signal</h3>
<ol type="1">
<li>PRI resets the link and detects presence of device (see above).</li>
<li>PRI pulls the signal LOW for OPT_WRIx_SIGNAL (x=0,1) time.</li>
<li>PRI pulls the signal HIGH and waits for the remainder of the time slot (OPT_WRIx_PAUSE).</li>
</ol>
<h3>Read Signal</h3>
<ol type="1">
<li>PRI resets the link and detects presence of device (see above).</li>
<li>PRI pulls the signal LOW for OPT_RD_INIT time.</li>
<li>At end of signal time, PRI switches the I/O pin to a digital input.</li>
<li>The SEC detects the read signal and switches to digital output.</li>
<li>The SEC signals a 1/0 by holding signal HIGH/LOW for OPT_RD_SIGNAL0 time.</li>
<li>At end of signal period SEC switches I/O pin to digital input.</li>
<li>The PRI samples the input at OPT_RD_SAMPLE time to detect line status.</li>
<li>After sampling slave write, PRI switches I/O to digital output and delays for OPT_RD_PAUSE time. </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">OnePin Lighweight Comms link</a></li>
    <li class="footer">Generated on Fri Sep 3 2021 13:07:56 for One Pin Comms Link by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
